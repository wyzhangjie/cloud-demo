<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.opay.payment.activity.provider.server.repository.ActivityRepository">
    <resultMap id="BaseResultMap" type="com.opay.payment.activity.provider.server.entity.Activity">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="activity_id" property="activityId" jdbcType="VARCHAR"/>
        <result column="name" property="name" jdbcType="VARCHAR"/>
        <result column="snapshot" property="snapshot" jdbcType="VARCHAR"/>
        <result column="service_type" property="serviceType" jdbcType="VARCHAR"/>
        <result column="pay_channel" property="payChannel" jdbcType="VARCHAR"/>
        <result column="business_type" property="businessType" jdbcType="VARCHAR"/>
        <result column="activity_type" property="activityType" jdbcType="VARCHAR"/>
        <result column="begin_time" property="beginTime" jdbcType="TIMESTAMP"/>
        <result column="end_time" property="endTime" jdbcType="TIMESTAMP"/>
        <result column="overload_user_id" property="overloadUserId" jdbcType="VARCHAR"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
        <result column="merchant_id" property="merchantId" jdbcType="VARCHAR"/>
        <result column="total_amount" property="totalAmount" jdbcType="BIGINT"/>
        <result column="left_amount" property="leftAmount" jdbcType="BIGINT"/>
        <result column="min_amount" property="minAmount" jdbcType="BIGINT"/>
        <result column="used_amount" property="usedAmount" jdbcType="BIGINT"/>
        <result column="deleted" property="deleted" jdbcType="CHAR"/>
        <result column="status" property="status" jdbcType="CHAR"/>
        <result column="service_ids" property="serviceIds" jdbcType="VARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
    </resultMap>
    <sql id="Base_Column_List">
    `id`, `activity_id`, `name`, `snapshot`, `service_type`, `pay_channel`, `business_type`, `activity_type`, `begin_time`,`remark`,
    `end_time`, `overload_user_id`, `merchant_id`, `total_amount`, `left_amount`,`used_amount`,`deleted`, `status`, `create_time`, `update_time`,`min_amount`,`service_ids`
  </sql>



    <select id="getActiveActivityOfCurrentTime" parameterType="com.opay.payment.activity.provider.server.vo.ActivityVo"
            resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from `activity`
        where 1=1
        <if test="serviceType != null and serviceType != ''">
            and (service_type = #{serviceType}
            or service_type ="all")
        </if>
        <if test="payChannel != null and payChannel != ''">
            and (pay_channel = #{payChannel}
            or pay_channel = "all")
        </if>
        <if test="businessType != null and businessType != ''">
            and (business_type = #{businessType}
            or business_type="all")
        </if>
        <if test="serviceIds != null and serviceIds != ''">
            and ( service_ids="all" or
                <foreach item="item" index="index" collection="serviceIds.split('/')" open="(" separator="or" close=")" >
                    service_ids like CONCAT('%',#{item},'%')
                </foreach>
            )
        </if>

        <if test="nowTime != null ">
            <![CDATA[ and begin_time <= #{nowTime} ]]>
        </if>
        <if test="nowTime != null ">
            <![CDATA[ AND end_time >= #{nowTime} ]]>
        </if>
        and status ='Y'
        and deleted='N'
    </select>
    <select id="getActiveActivityByActivityVo" parameterType="com.opay.payment.activity.provider.server.vo.ActivityVo"
            resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from `activity`
        where 1=1
        and activity_id = #{activityId}
        and snapshot = #{snapshot}
        <if test="serviceType != null and serviceType != ''">
            and (service_type = #{serviceType}
            or service_type ="all")
        </if>
        <if test="payChannel != null and payChannel != ''">
            and (pay_channel = #{payChannel}
            or pay_channel = "all")
        </if>
        <if test="businessType != null and businessType != ''">
            and (business_type = #{businessType}
            or business_type="all")
        </if>

    </select>
    <select id="getActivityByActivityIdAndSnapshot" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from `activity`
        where 1=1
        and activity_id = #{activityId}
        and snapshot = #{snapshot}
    </select>
    <update id="updateByActivityIdAndSnapshot" parameterType="com.opay.payment.activity.provider.server.entity.Activity">
        update `activity`
        <set>
            <if test="activityId != null">
                `activity_id` = #{activityId,jdbcType=VARCHAR},
            </if>
            <if test="name != null">
                `name` = #{name,jdbcType=VARCHAR},
            </if>
            <if test="snapshot != null">
                `snapshot` = #{snapshot,jdbcType=VARCHAR},
            </if>
            <if test="remark != null">
                `remark` = #{remark,jdbcType=VARCHAR},
            </if>
            <if test="serviceType != null">
                `service_type` = #{serviceType,jdbcType=VARCHAR},
            </if>
            <if test="payChannel != null">
                `pay_channel` = #{payChannel,jdbcType=VARCHAR},
            </if>
            <if test="minAmount != null ">
                 min_amount = #{minAmount,jdbcType=BIGINT} ,
            </if>
            <if test="businessType != null">
                `business_type` = #{businessType,jdbcType=VARCHAR},
            </if>
            <if test="activityType != null">
                `activity_type` = #{activityType,jdbcType=VARCHAR},
            </if>
            <if test="totalAmount != null">
                `total_amount` = #{totalAmount,jdbcType=BIGINT} ,
            </if>
            <if test="beginTime != null">
                `begin_time` = #{beginTime,jdbcType=TIMESTAMP},
            </if>
            <if test="endTime != null">
                `end_time` = #{endTime,jdbcType=TIMESTAMP},
            </if>
            <if test="overloadUserId != null">
                `overload_user_id` = #{overloadUserId,jdbcType=VARCHAR},
            </if>
            <if test="merchantId != null">
                `merchant_id` = #{merchantId,jdbcType=VARCHAR},
            </if>

            <if test="deleted != null">
                `deleted` = #{deleted,jdbcType=CHAR},
            </if>
            <if test="status != null">
                `status` = #{status,jdbcType=CHAR},
            </if>
            <if test="createTime != null">
                `create_time` = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                `update_time` = #{updateTime,jdbcType=TIMESTAMP},
            </if>
        </set>
        where 1=1
        and activity_id = #{activityId}
        and snapshot = #{snapshot}
    </update>

    <!-- 扣减活动优惠金额 -->
    <update id="deductActivityAmount" >
         UPDATE activity SET left_amount=left_amount-#{discountAmount} , used_amount=used_amount+ #{discountAmount} WHERE  id=#{id} AND left_amount-#{discountAmount}>=0
    </update>

    <!-- 增加活动优惠金额 -->
    <update id="increaseActivityAmount" >
         UPDATE activity SET  left_amount=left_amount+#{discountAmount} , used_amount=used_amount - #{discountAmount}  WHERE  id=#{id}
    </update>

</mapper>